---
title: "Raport śledzi"
author: "Adam Chojan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    css: custom.css
    keep_md: yes
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE,  echo=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE,cache=TRUE)
```


#Wprowadzenie
Tu będzie krótki opis

#Biblioteki
```{r library, echo=TRUE,message=FALSE, warnings = FALSE}
library(knitr)
library(dplyr)
library(ggplot2)
library(hexbin)
library(plotly)
library(reshape2)
library(mice)
library(tidyr)
```

```{r help_function}

normalit <- function(x){
  as.double(x)/max(as.double(x))
}


```

##Wczytanie danych
Dane zostały wczytane z pliku csv znajdującego się lokalnie na dysku do typu data frame. Po wczytaniu dokonanu również zmiany znaków symbolizujących brakujące dane w zestawie - ? na symbol NA w celu ułatwienia późniejszych operacji podczas analizy wartości brakujących. Ostatecznie dokonano konwersji na typ df_tbl pakietu dplyr.

Dane zostały pobrane ze strony: (http://www.cs.put.poznan.pl/dbrzezinski/teaching/zed/sledzie.csv)
```{r load_file, echo=TRUE,message=FALSE, cache = TRUE}
mydata = read.csv("sledzie.csv")
df <- data.frame(mydata)
df[df == '?'] <- NA
my_df <- tbl_df(df)
```

#Wstępne rozpoznanie
##Ogólne statystyki dla danych
Dane na, których oparto analizy dotyczą połowu śledzi oceanicznych wyławianych w Europie na przestrzeni 60 lat. Dane zostały zebrane podczas połowów komercyjnych. Do badań brano losowo od 50 do 100 sztuk trzyletnich śledzi.
```{r introduction}
kable(summary(my_df), caption = "Tabela podsumująca zbiór danych")

kable(head(my_df), caption = "Tabela zawierająca początkowe wiersze")

uniq <- my_df %>% summarise_each(funs(n_distinct(., na.rm = TRUE)))
kable(uniq, caption = "Tabela unikalnych wartości")
```

##Wartości brakujące
Z ogólnych statystyk dla danych dotyczących śledzi można odczytać 7 kolumn, które zawierają wartości brakujące. Ten rozdział raportu będzie poświęcony analizie tych wartości na podstawie, której zostanie podjęta decyzja w jaki sposób zostanie rozwiązany problem - zostawić brakujące wartości, usunąć wiersze z brakującymi wartościami lub wypełnić luki w danych.

###Analiza wartości brakujących
Pierwszym krokiem jest sprawdzenie jaka jest liczba unikalnych wartości dla poszczególnych atrybutów. W poniższej tabeli możemy zaobserwoać niewielką liczbę wartości różnych wartości dla zmiennych posiadających wartości brakujące. Zestaw danych posiada ponad 52 tysiące wiersze, dlatego zmienność danych jest w tych kolumnach nie wielka.

```{r missing_valeues_uniq, message=FALSE}
uniq_mv <- my_df %>% select(cfin1:lcop2,sst) %>% summarise_each(funs(n_distinct(., na.rm = TRUE)))
kable(uniq_mv, caption = "Tabela unikalnych wartości")
```

Następnie dokonano próby poszukania wzorcóW na podstawie ktorych można, by zdefiniwać zależności między brakami wartości, a atrybutami. Uzyskany jednak poniższy wykres ukazuję dużę liczbę kombinacji brakujących wartości (53). Są to pojedyncze, podWójne i potrójne braki w wierszu.  
```{r missing_valeues_pattern, message=FALSE, cache=TRUE}

only_missing_col <- select(my_df,cfin1:lcop2,sst)
missing_pattern <- tbl_df(md.pattern(only_missing_col))
missing_pattern2 <- select(missing_pattern,cfin2:lcop1)
missing_pattern2[missing_pattern2==0]<-NA

#Wykres wzorcóW brakujących wartości
missing_pattern2[-nrow(missing_pattern2),] %>% is.na %>% melt %>% ggplot(data = .,aes(x = Var2,y = Var1)) +
    geom_raster(aes(fill = value)) + scale_fill_grey(name = "",labels = c("Obecne","Brakujące")) + 
    theme_minimal() + theme(axis.text.x  = element_text(angle=45, vjust=0.5)) + 
    labs(x = "Zmienne z brakującymi wartościami", y="Wzorce brakujących wartości") + 
    ggtitle("Wykres wzorców brakujących wartości")

```


Wykonano również wykres przedstawiający liczbę brakujących wartości dla każdego atrybutu. Są one jednak bardzo zbliżonę i w tym wypadku nie można wskazać atrybutu wyróżniającego się.
```{r missing_value_plot}
mv_count <- melt(data= missing_pattern2[nrow(missing_pattern2),],)
plot_mv_count <- ggplot(mv_count,aes(x=variable,y=value, fill=variable))+geom_bar(stat="identity") + 
                    labs(x = "Zmienne z brakującymi wartościami", y="Liczba brakujących wartości") + 
                    ggtitle("Wykres liczby brakujących wartości") + 
                    theme_minimal() + theme(legend.position="none")
plot_mv_count
```

Ostatnim podejściem było obejrzenie danych źródłowych. Kolejne wiersze są zgrupowane  do pojedynczego połowu w pojedyncze połowy, w których jedyną różnicą są długości śledzi. Braki te występują bardzo często w środku takich bloków.

###Wypełnienie brakujących wartości
Na podstawie analizy trudno uzyskać jednoznaczny wzorzec brakujących wartości. Dane brakująće dotyczą poziomu planktonu oraz temperatury przy powierzchni wody. Nie są to atrybuuty o dużej zmienności. Próba wstawienia średniej, mediany lub innej wartości statystycznej może spowowdować duże zniekształcenie danych. Występowanie blokóW takich samych danych w zestawie jak i nie wielka liczba brakujących danych w stosunku do całości zbioru skłoniła do pobierania najbliższej wartości nie brakującej w kierunku do góry i wstawienie jej w puste miejsce. Dodatkowo w pierwszym wierszu występuje również pusta wartość, dlatego powtórzono operacje wstawiania w kierunku dolnym. Poniżej znajduję się kod wypelniający brakujące wartości.

```{r missing_fill,echo=TRUE}
new_my_df<-my_df %>% fill(cfin1:lcop2,sst,.direction = "up") %>% fill(cfin1:lcop2,sst,.direction = "down")
```

Przyjęta metoda nie zaburzyła w widoczny sposób podstawowych statystyk widocznych w poniższej tabli w stosunku do tabeli znajdującej się w sekcji 3.1.

```{r missing_fill_new_summary}
kable(summary(new_my_df, caption = "Tabela podstawowych statystyk po wypełnieniu brakujących wartości"))
```


#Analiza atrybutów
Zestaw danych zawiera 15 atrybutów. Dotyczą one parametrów morza - temperatura, zasolenie, oscylacja, dostępność planktonu, informacje dotyczące połowów oraz najważniejzy atrybut - długość śledzia.

##Długość śledzia

Na podstawie wykresów można dojśc do wniosku, że długość wyłowionego śledzia zwiekszała się do na przestrzenia lat do próbki eksperymentu ok. 15 tysięcy. Następnie widać stopniowy spadek długości śledzia, aż do końca zebranych danych.
```{r plot_sledzie_time,  cache=TRUE}
plot_length <- ggplot(new_my_df,aes(X,length))  + geom_line(alpha=0.3) + stat_smooth(method="auto",size = 2)
plot_length <- plot_length + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + labs(x="Czas", y="Długość śledzia") + theme_minimal() 
plot_length

plot_length_hex <- ggplot(new_my_df,aes(X,length)) +geom_hex()
plot_length_hex <- plot_length_hex + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + xlab("Czas") + ylab("Długość śledzia") + theme_minimal() 
ggplotly(plot_length_hex)
```


```{r plot_sledzie_hist}
plot_length_hist<- ggplot(new_my_df,aes(length)) + geom_histogram(binwidth=0.5, color="black", fill="lightblue") +
  theme_minimal() + labs(x = "Długość", y = "Liczba śledzi") + ggtitle("Histogram długości śledzia") 
  
plot_length_hist
```

##Parametry morza

###Temperatura przy powierzchni wody 
```{r nor_temp, echo=TRUE}
df_norm_temp <- new_my_df %>% select(X,length,xmonth,sst)  %>% transmute(X = X,length = normalit(length),xmonth=xmonth,sst = normalit(sst))
```

```{r polt_temp_sst}
plot_temp <- ggplot(df_norm_temp,aes(X)) +  geom_point(aes(y = sst,colour="temperatura"), size=0.7) +
  geom_smooth(aes(y=length,colour = "długość"),method="auto",size=1.7)+
  geom_smooth(aes(y=sst,colour = "temperatura trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + 
  theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + 
  labs(x = "Czas", y = "Temperatura / Długość śledzia") + ggtitle("Wykres temperatury przy powierzchni wody od czasu") 
plot_temp
```

###Poziom zasolenia wody
```{r nor_salt, echo=TRUE}
df_salt <- new_my_df %>% select(X,length,xmonth,sal)
```

```{r polt_salt_sal}
plot_sal <- ggplot(df_salt,aes(X)) +  geom_point(aes(y = sal,colour="zasolenie"), size=0.7) +
  geom_smooth(aes(y=sal,colour = "zasolenie trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + 
  theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + 
  labs(x = "Czas", y = "Zasolenie ") + ggtitle("Wykres zasolenia wody od czasu") 
plot_sal
```

###Oscylacja północnoatlantycka
```{r nor_nao, echo=TRUE}
df_norm_nao <- new_my_df %>% select(X,length,xmonth,nao)  %>% transmute(X = X,length = normalit(length),xmonth=xmonth,nao = normalit(nao))
```

```{r polt_nao_nao}
plot_nao <- ggplot(df_norm_nao,aes(X)) +  geom_point(aes(y = nao,colour="nao"), size=0.7) +
  geom_smooth(aes(y=length,colour = "długość"),method="auto",size=1.7)+
  geom_smooth(aes(y=nao,colour = "nao trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + 
  theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + 
  labs(x = "Czas", y = "NAO / Długość śledzia") + ggtitle("Wykres NAO od czasu") 
plot_nao
```

##Połowy

###Natężenie połowów

```{r polt_catch}
plot_catch <- ggplot(new_my_df,aes(X)) +  geom_point(aes(y = fbar,colour="natężenie"), size=0.7) +
  geom_smooth(aes(y=fbar,colour = "natężenie trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + 
  theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + 
  labs(x = "Czas", y = "Natężenie ") + ggtitle("Wykres natężenia połowów od czasu") 
plot_catch
```

###Łączna liczba ryb złowionych w ramach połowu

```{r polt_totaln}
plot_totaln <- ggplot(new_my_df,aes(X)) +  geom_point(aes(y = totaln,colour="złowione ryby"), size=0.7) +
  geom_smooth(aes(y=totaln,colour = "złowione ryby trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + 
  theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + 
  labs(x = "Czas", y = "złowione ryby ") + ggtitle("Wykres liczby złowionych ryb od czasu") 
plot_totaln
```

###Łączne roczne natężenie połowów w regionie 

```{r polt_catch_year}
plot_catch <- ggplot(new_my_df,aes(X)) +  geom_point(aes(y = cumf,colour="roczne natężenie"), size=1) +
  geom_smooth(aes(y=cumf,colour = "roczne natężenie trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + 
  theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + 
  labs(x = "Czas", y = "Roczne natężenie ") + ggtitle("Wykres  rocznego natężenia połowów w regionie czasu") 
plot_catch
```


###Roczny narybek

```{r polt_fry_year}
plot_fry <- ggplot(new_my_df,aes(X)) +  geom_point(aes(y = recr,colour="roczny narybek"), size=1) +
  geom_smooth(aes(y=recr,colour = "roczny narybek trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + 
  theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + 
  labs(x = "Czas", y = "Roczny narybek ") + ggtitle("Wykres rocznego narybka od czasu") 
plot_fry
```


##Dostepność planktonu
Poniżej zebrano wykresy przedstawiające dostępność planktonu 3 typów po dwa gatunki każdy. Wykresy te podzielono na  poszczególne miesiące w celu ułatwienia analizy czy zagęszczenie planktonu zmieniało się w sposób zauważalny na przestrzeni 60 lat. Dodatkowo dodano linię trendu długości śledzia. 

Przed wykonaniem wykresów dokonano normalizacjo danych w przedziale [0:1] w celu ujednoliceniu wartości i ułatwieniu porównania danych.
```{r nor_plank, echo=TRUE}

df_norm_plank <- new_my_df %>% select(X,length,xmonth,cfin1:lcop2)  %>% transmute(X = X,length = normalit(length),xmonth=xmonth,cfin1 = normalit(cfin1),cfin2 = normalit(cfin2),chel1 = normalit(chel1),chel2 = normalit(chel2),lcop1 = normalit(lcop1),lcop2 = normalit(lcop2))

```

###Calanus finmarchicus gat. 1

```{r polt_plank_cfin1}
plot_plank <- ggplot(df_norm_plank,aes(X)) +  geom_point(aes(y = cfin1,colour="plankton"), size=0.7) +
  geom_smooth(aes(y=length,colour = "długość"),method="auto",size=1.7)+ 
  geom_smooth(aes(y=cfin1,colour = "plankton trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + 
  theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + 
  labs(x = "Czas", y = "Plankton / Długość śledzia") + ggtitle("Wykres poziomu planktonu od czasu") 
plot_plank
```

###Calanus finmarchicus gat. 2

```{r polt_plank_cfin2}
plot_plank <- ggplot(df_norm_plank,aes(X)) +  geom_point(aes(y = cfin2,colour="plankton"), size=0.7) +
  geom_smooth(aes(y=length,colour = "długość"),method="auto",size=1.7)+ 
  geom_smooth(aes(y=cfin2,colour = "plankton trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank()) + 
  labs(x = "Czas", y = "Plankton / Długość śledzia") + ggtitle("Wykres poziomu planktonu od czasu")
plot_plank
```

###Calanus helgolandicus gat. 1

```{r polt_plank_chel1}
plot_plank <- ggplot(df_norm_plank,aes(X)) +  geom_point(aes(y = chel1,colour="plankton"), size=0.7) +
  geom_smooth(aes(y=length,colour = "długość"),method="auto",size=1.7)+ 
  geom_smooth(aes(y=chel1,colour = "plankton trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())  + 
  labs(x = "Czas", y = "Plankton / Długość śledzia") + ggtitle("Wykres poziomu planktonu od czasu")
plot_plank
```

###Calanus helgolandicus gat. 2


```{r polt_plank_chel2}
plot_plank <- ggplot(df_norm_plank,aes(X)) +  geom_point(aes(y = chel1,colour="plankton"), size=0.7) +
  geom_smooth(aes(y=length,colour = "długość"),method="auto",size=1.7)+ 
  geom_smooth(aes(y=chel2,colour = "plankton trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())  +
  labs(x = "Czas", y = "Plankton / Długość śledzia") + ggtitle("Wykres poziomu planktonu od czasu")
plot_plank
```

###Widłonogi gat. 1

```{r polt_plank_lcop1}
plot_plank <- ggplot(df_norm_plank,aes(X)) +  geom_point(aes(y = lcop1,colour="plankton"), size=0.7) +
  geom_smooth(aes(y=length,colour = "długość"),method="auto",size=1.7)+ 
  geom_smooth(aes(y=lcop1,colour = "plankton trend"),method="auto",size=1.7)+
  facet_wrap(~xmonth) + theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())  + 
  labs(x = "Czas", y = "Plankton / Długość śledzia") + ggtitle("Wykres poziomu planktonu od czasu")
plot_plank
```

###Widłonogi gat. 2

```{r polt_plank_lcop2}
plot_plank <- ggplot(df_norm_plank,aes(X)) +  geom_point(aes(y = lcop2,colour="plankton"), size=0.7) +
  geom_smooth(aes(y=length,colour = "długość"),method="auto",size=1.7)+ facet_wrap(~xmonth) + 
  geom_smooth(aes(y=lcop2,colour = "plankton trend"),method="auto",size=1.7)+
  theme_minimal() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())  + 
  labs(x = "Czas", y = "Plankton / Długość śledzia") + ggtitle("Wykres poziomu planktonu od czasu")
plot_plank
```





#Korelacja między zmiennymi
bedzie korelacja TODO
obliczenie korelacji + wykresy
```{r correlation}
kable(cor(df_norm_plank))
```

```{r correlation_plot}
plot_corr<- ggplot(new_my_df,aes(length,as.double(lcop1))) + geom_point() +
  geom_smooth(method="lm",size = 2) +
  theme_minimal() + labs(x = "Corr", y = "Corr") + ggtitle("Corr") 
  
plot_corr
```

#Regresor przewidujący rozmiar śledzia
bedzie regresor TODO

#Ważność atrybutów w oparciu o regresor
bedzie waznosc TODO

#Podsumowanie
bedzie podsumowanie TODO
